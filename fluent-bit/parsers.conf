# Fluent Bit Parsers Configuration
# Defines parsers for different log formats and multiline stack traces

# ============================================================================
# SINGLE-LINE PARSERS
# ============================================================================

[PARSER]
    Name        json
    Format      json
    Time_Key    timestamp
    Time_Format %Y-%m-%dT%H:%M:%S.%L%z
    Time_Keep   On

[PARSER]
    Name        docker
    Format      json
    Time_Key    time
    Time_Format %Y-%m-%dT%H:%M:%S.%L%z
    Time_Keep   On

[PARSER]
    Name        syslog
    Format      regex
    Regex       ^\<(?<pri>[0-9]+)\>(?<time>[^ ]* {1,2}[^ ]* [^ ]*) (?<host>[^ ]*) (?<ident>[a-zA-Z0-9_\/\.\-]*)(?:\[(?<pid>[0-9]+)\])?(?:[^\:]*\:)? *(?<message>.*)$
    Time_Key    time
    Time_Format %b %d %H:%M:%S

[PARSER]
    Name        micronaut_plain
    Format      regex
    Regex       ^(?<timestamp>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d+)\s+\[(?<thread>[^\]]+)\]\s+(?<level>ERROR|WARN|INFO|DEBUG|TRACE)\s+(?<logger>[^\s]+)\s+-\s+(?<message>[\s\S]*)$
    Time_Key    timestamp
    Time_Format %Y-%m-%dT%H:%M:%S.%L

# ============================================================================
# MULTILINE PARSERS (Stack Traces)
# ============================================================================

# Java Stack Trace Parser
[MULTILINE_PARSER]
    name          java_stacktrace
    Type          regex
    Flush_Timeout 5000

    # START: Matches a line starting with your timestamp format
    Rule start_state  ^(?<time>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3})\s+\[[^\]]+\]\s+(ERROR|WARN|FATAL)\s+.* cont

    # CONTINUE: Matches ANY line that DOES NOT start with that timestamp
    Rule   cont         ^(?!\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}).* cont

    Time_Key     time
    Time_Format  %Y-%m-%dT%H:%M:%S.%L




# Python Stack Trace Parser
[MULTILINE_PARSER]
    name          python_stacktrace
    type          regex
    flush_timeout 1000

    # First line
    rule "start_state" "/^Traceback \(most recent call last\):$/" "cont"

    # File lines
    rule "cont" "/^\s+File\s+\".*\", line \d+, in .*$/" "cont"

    # Code lines
    rule "cont" "/^\s{4,}.+$/" "cont"

    # Exception line (final line)
    rule "cont" "/^\w+(Error|Exception): .+$/" "cont"


# Node.js Stack Trace Parser
[MULTILINE_PARSER]
    name          nodejs_stacktrace
    type          regex
    flush_timeout 1000
    
    # Rules to match Node.js exceptions
    # First line: Error: message
    rule      "start_state"   "/^(?<exception_type>\w+Error):\s*(?<exception_message>.*)$/"  "cont"
    
    # Stack lines: at Function.name (/path/to/file.js:123:45)
    rule      "cont"          "/^\s+at\s+/"  "cont"

# Go Stack Trace Parser
[MULTILINE_PARSER]
    name          go_stacktrace
    type          regex
    flush_timeout 1000
    
    # Rules to match Go panics
    # First line: panic: message
    rule      "start_state"   "/^panic:\s*(?<exception_message>.*)$/"  "cont"
    
    # Goroutine line: goroutine 1 [running]:
    rule      "cont"          "/^goroutine\s+\d+\s+\[.*\]:$/"  "cont"
    
    # Function lines: package.function(args)
    rule      "cont"          "/^\w+\.\w+\(/"  "cont"
    
    # File lines: /path/to/file.go:123 +0xabc
    rule      "cont"          "/^\s+\/.*\.go:\d+\s+/"  "cont"

# .NET Stack Trace Parser
[MULTILINE_PARSER]
    name          dotnet_stacktrace
    type          regex
    flush_timeout 1000
    
    # Rules to match .NET exceptions
    # First line: System.Exception: message
    rule      "start_state"   "/^(?<exception_type>[\w\.]+Exception):\s*(?<exception_message>.*)$/"  "cont"
    
    # Stack lines: at Namespace.Class.Method(args) in File.cs:line 123
    rule      "cont"          "/^\s+at\s+/"  "cont"
    
    # Inner exception
    rule      "cont"          "/^\s+---> /"  "cont"

# Ruby Stack Trace Parser
[MULTILINE_PARSER]
    name          ruby_stacktrace
    type          regex
    flush_timeout 1000
    
    # Rules to match Ruby exceptions
    # First line: /path/to/file.rb:123:in `method': message (ExceptionType)
    rule      "start_state"   "/^.*\.rb:\d+:in\s+`.*':\s*(?<exception_message>.*)\s+\((?<exception_type>\w+Error)\)$/"  "cont"
    
    # Stack lines: from /path/to/file.rb:123:in `method'
    rule      "cont"          "/^\s+from\s+/"  "cont"

# PHP Stack Trace Parser
[MULTILINE_PARSER]
    name          php_stacktrace
    type          regex
    flush_timeout 1000
    
    # Rules to match PHP exceptions
    # First line: Fatal error: Uncaught ExceptionType: message in /path/to/file.php:123
    rule      "start_state"   "/^(?:Fatal error|PHP Fatal error):\s+Uncaught\s+(?<exception_type>\w+):\s*(?<exception_message>.*)\s+in\s+/"  "cont"
    
    # Stack trace line: Stack trace:
    rule      "cont"          "/^Stack trace:$/"  "cont"
    
    # Stack lines: #0 /path/to/file.php(123): function()
    rule      "cont"          "/^#\d+\s+/"  "cont"
    
    # Thrown in line
    rule      "cont"          "/^\s+thrown in\s+/"  "cont"

# ============================================================================
# APPLICATION-SPECIFIC PARSERS
# ============================================================================

# Apache Access Log
[PARSER]
    Name        apache
    Format      regex
    Regex       ^(?<host>[^ ]*) [^ ]* (?<user>[^ ]*) \[(?<time>[^\]]*)\] "(?<method>\S+)(?: +(?<path>[^\"]*?)(?: +\S*)?)?" (?<code>[^ ]*) (?<size>[^ ]*)(?: "(?<referer>[^\"]*)" "(?<agent>[^\"]*)")?$
    Time_Key    time
    Time_Format %d/%b/%Y:%H:%M:%S %z

# Nginx Access Log
[PARSER]
    Name        nginx
    Format      regex
    Regex       ^(?<remote>[^ ]*) (?<host>[^ ]*) (?<user>[^ ]*) \[(?<time>[^\]]*)\] "(?<method>\S+)(?: +(?<path>[^\"]*?)(?: +\S*)?)?" (?<code>[^ ]*) (?<size>[^ ]*)(?: "(?<referer>[^\"]*)" "(?<agent>[^\"]*)")?$
    Time_Key    time
    Time_Format %d/%b/%Y:%H:%M:%S %z

# Kubernetes Pod Log
[PARSER]
    Name        k8s-nginx-ingress
    Format      regex
    Regex       ^(?<host>[^ ]*) - (?<user>[^ ]*) \[(?<time>[^\]]*)\] "(?<method>\S+)(?: +(?<path>[^\"]*?)(?: +\S*)?)?" (?<code>[^ ]*) (?<size>[^ ]*) "(?<referer>[^\"]*)" "(?<agent>[^\"]*)" (?<request_length>[^ ]*) (?<request_time>[^ ]*) \[(?<proxy_upstream_name>[^ ]*)\] (\[(?<proxy_alternative_upstream_name>[^ ]*)\] )?(?<upstream_addr>[^ ]*) (?<upstream_response_length>[^ ]*) (?<upstream_response_time>[^ ]*) (?<upstream_status>[^ ]*) (?<req_id>[^ ]*).*$
    Time_Key    time
    Time_Format %d/%b/%Y:%H:%M:%S %z

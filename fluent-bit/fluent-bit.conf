# Fluent Bit Configuration for Luffy
# This configuration filters ERROR/FATAL logs and forwards them to Luffy's ingestion API

[SERVICE]
    # Flush logs every 5 seconds
    Flush        1
    
    # Run in foreground (for Docker/Kubernetes)
    Daemon       Off
    
    # Log level for Fluent Bit itself
    Log_Level    info
    
    # Parsers configuration file
    Parsers_File /fluent-bit/etc/parsers.conf
    
    # Enable HTTP server for monitoring
    HTTP_Server  On
    HTTP_Listen  0.0.0.0
    HTTP_Port    2020
    
    # Storage configuration for buffering
    storage.path              /var/log/fluent-bit-storage/
    storage.sync              normal
    storage.checksum          off
    storage.max_chunks_up     128
    storage.backlog.mem_limit 50M

# ============================================================================
# INPUT: Read application logs from files
# ============================================================================

[INPUT]
    Name              tail
    Path              /var/log/app/*.log
    Path_Key          file_path
    Tag               app.logs

    Multiline.Parser  java_stacktrace

    DB                /var/log/fluent-bit-state.db
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   Off
    Refresh_Interval  10
    Read_from_Head    False
    
    # Enable storage buffering
    storage.type      filesystem

# Alternative: Read from Docker container logs
# [INPUT]
#     Name              tail
#     Path              /var/lib/docker/containers/*/*.log
#     Parser            docker
#     Tag               docker.logs
#     Refresh_Interval  5
#     Mem_Buf_Limit     50MB

# Alternative: Read from systemd journal
# [INPUT]
#     Name              systemd
#     Tag               systemd.logs
#     Read_From_Tail    On
#     Strip_Underscores On


# ============================================================================
# FILTER: Parse multiline stack traces
# ============================================================================

# [FILTER]
#     Name                  multiline
#     Match                 app.logs
#     multiline.key_content message
#     multiline.parser      java_stacktrace
    # multiline.parser      java_stacktrace,python_stacktrace,nodejs_stacktrace,go_stacktrace
    
# ============================================================================
# FILTER: Only keep ERROR and FATAL logs
# ============================================================================

[FILTER]
    Name    parser
    Match   app.logs
    Key_Name log
    Parser  micronaut_plain

[FILTER]
    Name   grep
    Match  app.logs
    Regex  level (ERROR|FATAL|WARN|WARNING)


# ============================================================================
# FILTER: Add service metadata
# ============================================================================

[FILTER]
    Name    record_modifier
    Match   app.logs
    
    # Add service identification
    Record  service_id ${SERVICE_ID}
    Record  service_name ${SERVICE_NAME}
    Record  environment ${ENVIRONMENT}
    Record  hostname ${HOSTNAME}
    
    # Add timestamp if not present
#    Record  ingestion_timestamp ${TIMESTAMP}


# ============================================================================
# FILTER: Extract exception information (Lua script)
# ============================================================================

# [FILTER]
#     Name    lua
#     Match   app.logs
#     script  /fluent-bit/scripts/extract_exception.lua
#     call    extract_exception

# ============================================================================
# FILTER: Deduplicate logs (optional, can be done at API level)
# ============================================================================

# [FILTER]
#     Name    dedot
#     Match   app.logs

# ============================================================================
# OUTPUT: Send to Luffy ingestion API (Primary)
# ============================================================================

[OUTPUT]
    Name              http
    Match             app.logs
    Host              ${LUFFY_API_HOST}
    Port              ${LUFFY_API_PORT}
    URI               /api/v1/ingest/logs
    Format            json
    json_date_key     timestamp
    json_date_format  iso8601
    
    # Authentication
    Header            Authorization Bearer ${LUFFY_API_TOKEN}
    Header            Content-Type application/json
    
    # Retry configuration
    Retry_Limit       5
    
    # Connection settings
    net.keepalive                on
    net.keepalive_idle_timeout   30
    net.keepalive_max_recycle    2000
    
    # TLS/SSL (if using HTTPS)
    tls                Off
    tls.verify         Off
    # tls.ca_file      /path/to/ca.crt
    
    # Storage buffering for reliability
    storage.total_limit_size  100M

# # ============================================================================
# # OUTPUT: Send to OpenSearch/Elasticsearch (Optional, for archival)
# # ============================================================================

# [OUTPUT]
#     Name         opensearch
#     Match        micronaut
#     Host         luffy-opensearch
#     Port         9200
#     Index        micronaut-logs
#     Type         _doc
#     Logstash_Format Off
#     Suppress_Type_Name On
#     HTTP_User    admin
#     HTTP_Passwd  admin
#     tls          Off

# ============================================================================
# OUTPUT: Send to stdout (for debugging)
# ============================================================================

# Uncomment for local testing
# [OUTPUT]
#     Name   stdout
#     Match  app.logs
#     Format json_lines

# ============================================================================
# OUTPUT: Send to file (for backup/debugging)
# ============================================================================

# [OUTPUT]
#     Name  file
#     Match app.logs
#     Path  /var/log/fluent-bit-output/
#     File  luffy-logs.json
#     Format json_lines
